---
layout: post
title: Пишем директиву для Яндекс-карт
tags: [angular, yandex]
---

В AngularJS есть удобная вещь - директивы. С их помощью можно создавать свои html-теги и прописывать им свое поведение. Так, например можно реализовать тег `<yandex-map>` который будет создавать на странице карту. Если в проекте используется Angular  &mdash; то вставлять карту через директиву &mdash; это хорошее решение. А если есть несколько проектов, в каждом из которых нужна карта, то можно использовать однин компонент на всех &mdash; и это самое лучшее решение. У меня возникла такая ситуация, и для ее разрешения появилась новая библитотека &mdash; [angular-ymaps](http://catatron.com/angular-ymaps/). На демо-странице можно посмотреть на директиву в действии, а здесь я расскажу о деталях реализации, которые оказались неожданными и получились в ходе скрещивания двух API.

###Подключение 

Для подключения необходимых картам скриптов я решил использовать ленивую загрузку, описанную в [прошлой статье]({% post_url 2013-07-22-angular-lazy-script-loading %}). Для карт это как нельзя лучше, так как они всегда загружаются с сервера Яндекс, а значит этот скрипт в любом случае нельзя будет сложить и упаковать с остальными, так что путь он лучше грузится ассинхронно, только если он действительно необходим. Для того, чтобы можно было распространять карты, единым модулем, без своих зависимостей, сервис скрипта был скопирован напрямую в него, однако вызов его получается точно таким же:
{% highlight javascript %}
$script.get(YANDEX_MAP_URL).then(function() {
	//теперь доступны методы ymaps
});
{% endhighlight %}

###Управление картой

Для настройки и управления директивой angular дает несколько рычагов. Однако, чтобы карта была простой и удобной в ипользовании, нужно правильно их использовать. Основные параметры, как правило, постоянные для конкретного проекта хранятся в отдельной константе, которую можно переопределить. Таким образом, можно добавить возможность менять масштаб карты скроллом мыши или изменить цвет маркеров или включить подстройку границ карты, чтобы было показать все маркеры. Для настройки отдельного экземляра карты (задания центра и масштаба), использутся атрибуты тега карт. 

Самое интересное - это маркеры. Поскольку это содержимое карты, то его логично так и написать внутри тега карт. К счастью такая возможность у нас есть. Посмотрев как это сделано в [Angular-UI tabs](http://angular-ui.github.io/bootstrap/#/tabs), я написал для этого директиву `ymap-marker`. Настройки, касающиеся отдельной точки на карте, например координаты или содержимое метки, передаются через ее атрибуты. Оформление маркеров в виде отдельной директивы позволяет дополнить их другими директивами, например усилить мощью `ng-repeat`, которая может вывести массив, а при необходимости и отфильтровать его. Однако при реализации такой схемы пришлось учесть некторые нюансы в работе YandexMaps API, которые будут описаны дальше.

###Отложенная компиляция содержимого

В директиве используется содержимое тега карты для добавления маркеров на нее. Это одна из возможностей Angular, которая реализуется через атрибут reqiure в описании директивы маркера. В контроллере карты описываем методы добавления маркеров на карту, и можно попытаться это запустить, но ничего не получится. Это все из-за того, что на этапе компиляции директивы маркера, карта еще не создана, ведь Яндекс тоже заботится о нашем траффике и загружает основной модуль карт ассинхронно. Поэтому все действия по созданию карты и ее маркеров должны производиться после окончания загрузки карт. Для этого мы отложим компиляцию содержимого карты до срабатывания коллбека в [ymaps.ready](http://api.yandex.ru/maps/doc/jsapi/2.x/ref/reference/ready.xml). Для доступа к содержимому нужно определить функцию `compile`, в которой произведем все необходимые загрузки.
{% highlight javascript %}
compile: function(tElement) {
	//заберем себе содержимое и очистим элемент
    var childNodes = tElement.contents();
    tElement.html('');
	//теперь подождем пока angular сделает свои дела и вернет нам управление
    return function($scope, element) {
    	//теперь можно загружать API карт, потом дождаться срабатывания коллбека
        $script.get(YANDEX_MAP_URL).then(function() {
            ymaps.ready(function() {
            	//теперь карты к нашим услугам
				//создание и настройка карты здесь пропущены
				...
				//теперь возвращаем на место наши маркеры
                element.append(childNodes);
                //поскольку angular ничего не знает о картах
                //то нужно ему об этом сообщить через $apply
                $scope.$apply(function() {
                	//теперь можно скомпилировать содержимое
                	//и добавить маркеры на карту
                    $compile(childNodes)($scope.$parent);
                });
            });
        });
    };
}
{% endhighlight %}

В резульате получилась цепочка ассинхронных функций которые активируют создание маркеров для карты после того как карта будет готова.

###Сборка проекта

Файлы сторонних библиотек обычно используются в упакованном виде, чтобы сэкономить загружаемый объем. Эта библиотека тоже лучше смотрится в минимизированной форме. Для сжатия используется [Grunt](gruntjs.com) со своим модулем [contrib-uglify](https://github.com/gruntjs/grunt-contrib-uglify). Кроме того, нужно ознакомиться с работой [dependency injection](http://docs.angularjs.org/guide/di) в AngularJS, поскольку не все формы описания зависимостей уцелеют после упаковки. Также об этом рассказывается на [5 шаге Angular Tutorial](http://docs.angularjs.org/tutorial/step_05). 

В результате получилась удобная библиотека для работы с Яндекс-картами в проектах, основанных на Angular.А если кто-то захочет использовать Angular, увидев как там работают карты &mdash; то это вообще прекрасно.

[Демо-страница и описание библиотеки](http://catatron.com/angular-ymaps/)