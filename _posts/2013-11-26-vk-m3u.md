---
layout: post
title: Сбор плейлистов из страниц ВК
tags: [angular, vk, topcoat]
---
Написал для себя утилитку, составляющую плейлисты .m3u из страниц сайта [vk.com](https://vk.com), чтобы слушать музыку в любимом проигрывателе. Основная идея приложения - разбор url и запрос списка треков через API. Сейчас приложение понимает:

* Собственные аудиозаписи [vk.com/audio](http://vk.com/audio)
* Аудиозаписи пользователя или группы [vk.com/audios13033](http://vk.com/audios13033), понимаются ссылки на альбом &mdash; [vk.com/audios13033?album_id=38342240](http://vk.com/audios13033?album_id=38342240)
* Аудиозаписи со стены пользователя [vk.com/wall2113609](http://vk.com/wall2113609) или группы [vk.com/wall-38872565](http://vk.com/wall-38872565). Распознаются и ссылки на только записи сообщества [vk.com/wall-38872565?own=1](http://vk.com/wall-38872565?own=1)
* Прямые ссылки на страницы [vk.com/warm_on](http://vk.com/warm_on) &mdash; в этом случае загружается аудио со стены

После вставки ссылки, если приложение ее распознает, можно будет скачать плейлист со всеми треками с указаной страницы. Чтобы правильно показывались русские буквы, нужно вручную изменить расширение с `m3u` на `m3u8`, потому что файл сохраняется в UTF-8. Еще хочу заметить, скачиваются не сами треки, а ссылки на них, треки будут играть из онлайна и на компьютере не сохранятся.

[Перейти к приложению](http://catatron.com/vk-m3u/)

###Технические подробности

Как обычно, приложение построено на AngularJS, а код выложен на [Github](https://github.com/just-boris/vk-m3u). Функционал приложения разнесен по модулям, отдельный модуль занимается разбором введенных ссылок на соствляющие. ВКонтакте предоставляет JS-API, вокруг которого я написал Angular-модуль для интеграции запросов к API в цикл $digest и оборачивания их в promises через $q. После загрузки списка треков они направляются в модуль `playlist`, где из них соберется правильный `m3u`-файл. Результат возвращается в виде data-URI, закодированного в Base64. Результат можно сохранить и пользоваться.

Небольшие трудности возникли с загрузкой аудиозаписей со стен. API возвращает не более 100 записей, а их может быть намного больше. Для этого случая делается рекурсивный вызов запросов до тех пор, пока не кончатся записи на стене или сервер не объявит о превышении лимита на запросы.

В проекте использовался недавно вышедший AngularJS v1.2.2. Поле ввода адреса посылает запрос тогда и только тогда, когда закончился ввод, для этого оно обложено слушателями на события submit, blur и paste. Сделать это без дополнительного JS позволяют появившиеся в версии 1.2 директивы `ng-blur` и `ng-paste` (paste работает только в хороших браузерах, не пользуйтесь плохими, пожалуйста).

Также в проекте я попробовал новую для себя UI-библиотеку &mdash; [topcoat.io](http://topcoat.io). У контролов приятный вид, а для организации классов используется БЭМ, которым я тоже интересуюсь. Результат радует, эта библиотека лучше Semantic-UI, на котором была построена [другая демка]({% post_url 2013-10-06-recursive-tree %}).